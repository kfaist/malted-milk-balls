<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Video Only</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            width: 100vw; 
            height: 100vh; 
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="status">Initializing...</div>
    <video id="remoteVideo" autoplay playsinline></video>
    
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.8/dist/livekit-client.umd.min.js"></script>
    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const status = document.getElementById('status');
        let room = null;
        let statusLog = [];

        function updateStatus(msg) {
            statusLog.push(msg);
            if (statusLog.length > 8) statusLog.shift();
            status.innerHTML = statusLog.join('<br>');
            console.log(msg);
        }

        function attachVideoTrack(track, participantIdentity) {
            updateStatus(`üìπ Attaching video from ${participantIdentity}`);
            const element = track.attach();
            remoteVideo.srcObject = element.srcObject;
            setTimeout(() => status.style.display = 'none', 5000);
        }

        async function autoConnect() {
            try {
                updateStatus('Fetching token...');
                const response = await fetch('/api/participant-token');
                const data = await response.json();
                
                updateStatus('Connecting to LiveKit...');
                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true
                });
                
                // Handle NEW participants joining
                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    updateStatus(`‚úì ${participant.identity} joined`);
                });
                
                // Handle NEW tracks being subscribed
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    updateStatus(`‚úì New track: ${track.kind}`);
                    
                    if (track.kind === LivekitClient.Track.Kind.Video) {
                        attachVideoTrack(track, participant.identity);
                    }
                });
                
                // Connect to room
                await room.connect(data.url, data.token);
                updateStatus('‚úì Connected to room!');
                
                // Check for EXISTING participants and tracks
                setTimeout(() => {
                    updateStatus(`Checking for existing tracks...`);
                    
                    room.remoteParticipants.forEach((participant) => {
                        updateStatus(`Found: ${participant.identity}`);
                        
                        participant.trackPublications.forEach((publication) => {
                            updateStatus(`- Track: ${publication.kind} (${publication.subscribed ? 'subscribed' : 'not subscribed'})`);
                            
                            if (publication.track && publication.kind === 'video') {
                                attachVideoTrack(publication.track, participant.identity);
                            }
                        });
                    });
                }, 1000);
                
            } catch (error) {
                updateStatus('‚ùå ' + error.message);
                console.error('Connection error:', error);
                setTimeout(autoConnect, 5000);
            }
        }

        autoConnect();
    </script>
</body>
</html>
